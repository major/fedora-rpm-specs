# Page at dns-oarch.net:
# https://www.dns-oarc.net/tools/dnsjit
%global url_files https://www.dns-oarc.net/files/%{name}

Name:           dnsjit
Version:        1.5.0
Release:        %autorelease
Summary:        Engine for capturing, parsing and replaying DNS
Group:          Productivity/Networking/DNS/Utilities

License:        GPL-3.0-or-later
URL:            https://codeberg.org/DNS-OARC/dnsjit
VCS:            git:%{url}
# Source needs to be generated by dist-tools/create-source-packages, see
# https://github.com/jelu/dist-tools
Source0:        %{url_files}/%{name}-%{version}.tar.gz

# https://codeberg.org/DNS-OARC/dnsjit/pulls/269
Patch1:         dnsjit-s390x-ipsplit.patch

BuildRequires:  gcc
BuildRequires:  make
BuildRequires:  libpcap-devel
%if 0%{?suse_version} || 0%{?sle_version}
BuildRequires:  liblz4-devel
%else
BuildRequires:  lz4-devel
%endif
BuildRequires:  luajit-devel >= 2.0.0
BuildRequires:  lmdb-devel
BuildRequires:  ck-devel
BuildRequires:  gnutls-devel
BuildRequires:  libzstd-devel
BuildRequires:  zlib-devel
BuildRequires:  xz-devel
BuildRequires:  autoconf >= 2.64
BuildRequires:  automake
BuildRequires:  libtool

# luajit dependency is not built for all platforms.
ExcludeArch:    riscv64 ppc64 ppc64le
%if 0%{?rhel}
# https://github.com/LuaJIT/LuaJIT/pull/631
# No RHEL seems to have luajit support for s390x
ExcludeArch:    s390x
%endif

%description
dnsjit is a combination of parts taken from dsc, dnscap, drool,
and put together around Lua to create a script-based engine for easy
capturing, parsing and statistics gathering of DNS message while also
providing facilities for replaying DNS traffic.


%package devel
Summary:    Engine for capturing, parsing and replaying DNS - development files
Group:      Development/Libraries/C and C++
Requires:   %{name}%{?_isa} = %{version}-%{release}
Requires:   libpcap-devel
Requires:   luajit-devel >= 2.0.0
Requires:   lmdb-devel
Requires:   ck-devel
Requires:   gnutls-devel
%if 0%{?suse_version} || 0%{?sle_version}
Requires:   liblz4-devel
%else
Requires:   lz4-devel
%endif
Requires:   libzstd-devel
Requires:   zlib-devel
Requires:   xz-devel

%description devel
dnsjit is a combination of parts taken from dsc, dnscap, drool,
and put together around Lua to create a script-based engine for easy
capturing, parsing and statistics gathering of DNS message while also
providing facilities for replaying DNS traffic.

This package includes development files needed to create dnsjit modules.


%package examples
BuildArch:  noarch
Summary:    Engine for capturing, parsing and replaying DNS - examples
Group:      Productivity/Networking/DNS/Utilities
Requires:   %{name} = %{version}-%{release}

%description examples
dnsjit is a combination of parts taken from dsc, dnscap, drool,
and put together around Lua to create a script-based engine for easy
capturing, parsing and statistics gathering of DNS message while also
providing facilities for replaying DNS traffic.

This package includes examples of prepared scripts.


%prep
%autosetup -p1


%build
autoreconf
%configure
%make_build


%install
%make_install

# executables do not belong into doc directory
rm -f %{buildroot}%{_datadir}/doc/%{name}/*.lua
# we put this to different place
rm -f %{buildroot}%{_datadir}/doc/%{name}/LICENSE
mkdir -p %{buildroot}%{_libexecdir}/%{name}/
cp -p examples/*.lua %{buildroot}%{_libexecdir}/%{name}/


%check
%ifnarch s390x
%make_build test
%else
# Some tests are failing on s390x only, known issue
# https://codeberg.org/DNS-OARC/dnsjit/issues/250
# https://bugzilla.redhat.com/show_bug.cgi?id=2323980#c7
%make_build test TEST_IPSPLIT=''
%endif


%files
%license LICENSE
%doc README.md
%doc CHANGES
%{_bindir}/%{name}*
%{_mandir}/man1/%{name}*
%{_mandir}/man3/%{name}*

%files devel
%{_includedir}/%{name}/

%files examples
%{_libexecdir}/%{name}/

%changelog
%autochangelog
