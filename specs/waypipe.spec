# Generated by rust2rpm 27
%bcond check 1

# prevent library files from being installed
%global cargo_install_lib 0

Name:           waypipe
Version:        0.10.5
Release:        %autorelease
Summary:        Wayland forwarding proxy

SourceLicense:  GPL-3.0-or-later
# GPL-3.0-or-later
# ISC
# MIT
# MIT OR Apache-2.0
# (also MIT for the protocols/ directory)
License:        GPL-3.0-or-later AND (Apache-2.0 OR MIT) AND ISC AND MIT
# LICENSE.dependencies contains a full license breakdown

URL:            https://gitlab.freedesktop.org/mstoeckl/waypipe
Source0:        https://gitlab.freedesktop.org/mstoeckl/waypipe/-/archive/v%{version}/%{name}-v%{version}.tar.gz
Source1:        waypipe.1
Patch1:         license.patch

BuildRequires:  cargo-rpm-macros >= 26
BuildRequires:  bindgen-cli
BuildRequires:  gcc
# required for bindgen to resolve some include paths..
BuildRequires:  clang
BuildRequires:  meson
%if !0%{?rhel}
BuildRequires:  scdoc
%endif
BuildRequires:  pkgconfig(gbm)
%if !0%{?rhel}
BuildRequires:  pkgconfig(libavcodec)
BuildRequires:  pkgconfig(libavutil)
BuildRequires:  pkgconfig(libswscale)
# not sure if needed without ffmpeg?
BuildRequires:  glslc
BuildRequires:  vulkan-headers
%endif
BuildRequires:  pkgconfig(libdrm)
BuildRequires:  pkgconfig(liblz4)
BuildRequires:  pkgconfig(libzstd)
BuildRequires:  pkgconfig(libva)
BuildRequires:  pkgconfig(wayland-protocols)
BuildRequires:  pkgconfig(wayland-client)
BuildRequires:  pkgconfig(wayland-server)
# This one is not automatically detected properly...
BuildRequires:  rust-pkg-config+default-devel

%global _description %{expand:
%{summary}.}

%description %{_description}

%prep
%autosetup -n waypipe-v%{version} -p1
%cargo_prep

%generate_buildrequires
%cargo_generate_buildrequires

%build
%cargo_build
%{cargo_license_summary}
%{cargo_license} > LICENSE.dependencies
%if !0%{?rhel}
scdoc < waypipe.scd > waypipe.1
%endif

%install
%cargo_install
# Is there a better way to build only `--bin waypipe` ?
rm -f %{buildroot}%{_bindir}/test_proto
%if !0%{?rhel}
install -D -p -m 0644 waypipe.1 %{buildroot}%{_mandir}/man1/waypipe.1
%else
install -D -p -m 0644 %{SOURCE1} %{buildroot}%{_mandir}/man1/waypipe.1
%endif

%if %{with check}
%check
%cargo_test
%endif

%files
%{_bindir}/waypipe
%{_mandir}/man1/waypipe.1*
%doc CONTRIBUTING.md README.md
%license LICENSE.GPLv3
%license LICENSE.MIT
%license LICENSE.dependencies

%changelog
%autochangelog
