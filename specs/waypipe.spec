# Generated by rust2rpm 27
%bcond check 1

# prevent library files from being installed
%global cargo_install_lib 0

# Default features in Cargo.toml, except:
# video: requires ffmpeg (not included in RHEL)
# test_proto: only needed in %%check
%global features %{!?rhel:video,}dmabuf,lz4,zstd,gbmfallback
%global test_features test_proto

Name:           waypipe
Version:        0.10.5
Release:        %autorelease
Summary:        Wayland forwarding proxy

SourceLicense:  GPL-3.0-or-later
# GPL-3.0-or-later
# ISC
# MIT
# MIT OR Apache-2.0
# (also MIT for the protocols/ directory)
License:        GPL-3.0-or-later AND (Apache-2.0 OR MIT) AND ISC AND MIT
# LICENSE.dependencies contains a full license breakdown

URL:            https://gitlab.freedesktop.org/mstoeckl/waypipe
Source0:        https://gitlab.freedesktop.org/mstoeckl/waypipe/-/archive/v%{version}/%{name}-v%{version}.tar.gz
Source1:        waypipe.1
Patch1:         license.patch
Patch2:         cargo-workspace.patch

BuildRequires:  cargo-rpm-macros >= 26
BuildRequires:  bindgen-cli
BuildRequires:  gcc
# required for bindgen to resolve some include paths..
BuildRequires:  clang
BuildRequires:  meson
%if !0%{?rhel}
BuildRequires:  scdoc
%endif
BuildRequires:  pkgconfig(gbm)
%if !0%{?rhel}
BuildRequires:  pkgconfig(libavcodec)
BuildRequires:  pkgconfig(libavutil)
BuildRequires:  pkgconfig(libswscale)
BuildRequires:  glslc
BuildRequires:  vulkan-headers
%endif
BuildRequires:  pkgconfig(libdrm)
BuildRequires:  pkgconfig(liblz4)
BuildRequires:  pkgconfig(libzstd)
BuildRequires:  pkgconfig(libva)
BuildRequires:  pkgconfig(wayland-protocols)
BuildRequires:  pkgconfig(wayland-client)
BuildRequires:  pkgconfig(wayland-server)

%global _description %{expand:
%{summary}.}

%description %{_description}

%prep
%autosetup -n waypipe-v%{version} -p1
%cargo_prep

%generate_buildrequires
%cargo_generate_buildrequires -n -f %{features},%{test_features}

%build
%cargo_build -n -f %{features}
%{cargo_license_summary}
%{cargo_license} > LICENSE.dependencies
%if !0%{?rhel}
scdoc < waypipe.scd > waypipe.1
%endif

%install
%cargo_install -n -f %{features}
%if !0%{?rhel}
install -D -p -m 0644 waypipe.1 %{buildroot}%{_mandir}/man1/waypipe.1
%else
install -D -p -m 0644 %{SOURCE1} %{buildroot}%{_mandir}/man1/waypipe.1
%endif

%if %{with check}
%check
%cargo_test -n -f %{features},%{test_features}
%endif

%files
%{_bindir}/waypipe
%{_mandir}/man1/waypipe.1*
%doc CONTRIBUTING.md README.md
%license LICENSE.GPLv3
%license LICENSE.MIT
%license LICENSE.dependencies

%changelog
%autochangelog
