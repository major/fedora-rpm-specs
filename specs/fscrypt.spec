# Generated by go2rpm 1.19.0
%bcond check 1

# These aren't defined on EPEL 9
%{!?_pam_moduledir:%global _pam_moduledir %{_libdir}/security}
%{!?_pam_vendordir:%global _pam_vendordir %{_datadir}/pam.d}

# https://github.com/google/fscrypt
%global goipath         github.com/google/fscrypt
Version:                0.3.6

%gometa -L -f


Name:           fscrypt
Release:        1%{?dist}
Summary:        Go tool for managing Linux filesystem encryption

# Generated by go-vendor-tools
License:        Apache-2.0 AND BSD-2-Clause AND BSD-3-Clause AND MIT
URL:            %{gourl}
Source0:        %{gosource}
# Generated by go-vendor-tools
Source1:        %{archivename}-vendor.tar.bz2
Source2:        go-vendor-tools.toml
Source3:        %{name}.pam

BuildRequires:  go-vendor-tools
# Non-Go build dependencies
BuildRequires:  gcc
BuildRequires:  pam-devel

Requires:       (pam_%{name}%{?_isa} = %{version}-%{release} if pam%{?_isa})

%description
fscrypt is a high-level tool for the management of Linux filesystem encryption.
This tool manages metadata, key generation, key wrapping, PAM integration, and
provides a uniform interface for creating and modifying encrypted directories.

%package -n     pam_%{name}
Summary:        PAM module for managing Linux filesystem encryption
Requires:       %{name}%{?_isa} = %{version}-%{release}

%description -n pam_%{name}
fscrypt modele for PAM

This is the PAM module associated with %{name}.


%prep
%goprep -p1
tar -xf %{S:1}

%generate_buildrequires
%go_vendor_license_buildrequires -c %{S:2}

%build
%global gomodulesmode GO111MODULE=on
for cmd in cmd/* ; do
  %gobuild -o %{gobuilddir}/bin/$(basename $cmd) %{goipath}/$cmd
done
for cmd in pam_fscrypt; do
  %gobuild -o %{gobuilddir}/lib/$(basename $cmd).so %{goipath}/$cmd
done

%install
%go_vendor_license_install -c %{S:2}
install -m 0755 -vd                     %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/* %{buildroot}%{_bindir}/
install -m 0755 -vd                     %{buildroot}%{bash_completions_dir}
install -m 0644 -vp cmd/fscrypt/fscrypt_bash_completion %{buildroot}%{bash_completions_dir}/%{name}
install -m 0755 -vd                     %{buildroot}%{_pam_moduledir}
install -m 0644 -vp %{gobuilddir}/lib/pam_%{name}.so %{buildroot}%{_pam_moduledir}/
install -m 0755 -vd                     %{buildroot}%{_pam_vendordir}
install -m 0644 -vp %{SOURCE3}          %{buildroot}%{_pam_vendordir}/%{name}

%check
%go_vendor_license_check -c %{S:2}
%if %{with check}
%gotest ./...
%endif

%files -f %{go_vendor_license_filelist}
%doc CODE_OF_CONDUCT.md CONTRIBUTING.md NEWS.md README.md
%{_bindir}/fscrypt
%{bash_completions_dir}/%{name}

%files -n pam_%{name}
%license LICENSE
%{_pam_moduledir}/pam_%{name}.so
%{_pam_vendordir}/%{name}


%changelog
* Tue Feb 17 2026 Mikel Olasagasti Uranga <mikel@olasagasti.info> - 0.3.6-1
- Update to 0.3.6
- Adopt Go Vendor Tools rhbz#2434054
- Change file perms to 0644

* Mon Feb 02 2026 Maxwell G <maxwell@gtmx.me> - 0.3.5-7
- Rebuild for https://fedoraproject.org/wiki/Changes/golang1.26

* Fri Jan 16 2026 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.5-6
- Rebuilt for https://fedoraproject.org/wiki/Fedora_44_Mass_Rebuild

* Fri Oct 10 2025 Alejandro SÃ¡ez <asm@redhat.com> - 0.3.5-5
- rebuild

* Fri Aug 15 2025 Maxwell G <maxwell@gtmx.me> - 0.3.5-4
- Rebuild for golang-1.25.0

* Wed Jul 23 2025 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.5-3
- Rebuilt for https://fedoraproject.org/wiki/Fedora_43_Mass_Rebuild

* Mon Feb 24 2025 Neal Gompa <ngompa@fedoraproject.org> - 0.3.5-2
- Backport fix for tests on non-x86 arches

* Fri Feb 14 2025 Neal Gompa <ngompa@fedoraproject.org> - 0.3.5-1
- Update to 0.3.5
- Add patch to fix building tests with Go 1.24

* Thu Jan 16 2025 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.4-7
- Rebuilt for https://fedoraproject.org/wiki/Fedora_42_Mass_Rebuild

* Wed Jul 17 2024 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.4-6
- Rebuilt for https://fedoraproject.org/wiki/Fedora_41_Mass_Rebuild

* Sun Feb 11 2024 Maxwell G <maxwell@gtmx.me> - 0.3.4-5
- Rebuild for golang 1.22.0

* Wed Jan 24 2024 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.4-4
- Rebuilt for https://fedoraproject.org/wiki/Fedora_40_Mass_Rebuild

* Fri Jan 19 2024 Fedora Release Engineering <releng@fedoraproject.org> - 0.3.4-3
- Rebuilt for https://fedoraproject.org/wiki/Fedora_40_Mass_Rebuild

* Thu Dec 21 2023 Davide Cavalca <dcavalca@fedoraproject.org> - 0.3.4-2
- Make it build on EPEL 9

* Sat Sep 02 2023 Neal Gompa <ngompa@fedoraproject.org> - 0.3.4-1
- Initial package

