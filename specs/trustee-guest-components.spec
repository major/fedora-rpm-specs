# Generated by rust2rpm 27
%bcond check 1

%global projectname guest-components

Name:           trustee-guest-components
Version:        0.14.0
Release:        %autorelease
Summary:        Tools that run in confidential VMs, attest and get secrets from Trustee

# License lines copied from the build
#Apache-2.0
#Apache-2.0 OR BSL-1.0
#Apache-2.0 OR MIT
#Apache-2.0 WITH LLVM-exception OR Apache-2.0 OR MIT
#BSD-2-Clause OR Apache-2.0 OR MIT
#ISC
#MIT
#MIT OR Apache-2.0
#(MIT OR Apache-2.0) AND Unicode-DFS-2016
#MPL-2.0
#Unicode-3.0
#Unlicense OR MIT

# License lines above, but sorted within and between lines
#Apache-2.0
#Apache-2.0 OR Apache-2.0 WITH LLVM-exception OR MIT
#Apache-2.0 OR BSD-2-Clause OR MIT
#Apache-2.0 OR BSL-1.0
#Apache-2.0 OR MIT
#(Apache-2.0 OR MIT) AND Unicode-DFS-2016
#BSD-2-Clause OR Apache-2.0 OR MIT
#ISC
#MIT
#MIT OR Unlicense
#MPL-2.0
#Unicode-3.0

License:        Apache-2.0 AND (Apache-2.0 OR Apache-2.0 WITH LLVM-exception OR MIT) AND (Apache-2.0 OR BSD-2-Clause OR MIT) AND (Apache-2.0 OR BSL-1.0) AND (Apache-2.0 OR MIT) AND ((Apache-2.0 OR MIT) AND Unicode-DFS-2016) AND (BSD-2-Clause OR Apache-2.0 OR MIT) AND ISC AND MIT AND (MIT OR Unlicense) AND MPL-2.0 AND Unicode-3.0

# LICENSE.dependencies contains a full license breakdown

URL:            https://github.com/confidential-containers/guest-components
Source:         https://github.com/confidential-containers/%{projectname}/archive/refs/tags/v%{version}/%{projectname}-%{version}.tar.gz

# * Remove workspace members which are not built
Patch1:         0001-Fedora-Remove-workspace-members-which-are-not-built.patch
# * deps/crypto defaults to openssl
Patch2:         0002-Fedora-AA-deps-crypto-default-to-openssl.patch
# * kbs_protocol defaults to openssl
Patch3:         0003-Fedora-kbs_protocol-default-to-openssl.patch
# * pick attesters to build
Patch4:         0004-Fedora-attester-pick-attesters-in-all-attesters.patch
# * remove dependency ttrpc - not in Fedora
Patch5:         0005-Fedora-remove-ttrpc-dependency.patch
# * remove dependency jwt-simple - not in Fedora
Patch6:         0006-Fedora-remove-jwt-simple-dependency.patch
# * remove dependency testcontainers - not in Fedora
Patch7:         0007-Fedora-remove-testcontainers-dependency.patch
# * rstest version is 0.26
Patch8:         0008-Fedora-rstest-0.26.patch
# * tempfile version is 3.21
Patch9:         0009-Fedora-tempfile-3.21.patch
# * tokio version is 1.47
Patch10:         0010-Fedora-tokio-1.47.patch
# * zeroize version is 1.8.1
Patch11:         0011-Fedora-zeroize-1.8.1.patch
# * Use clap ^4.2.7
Patch12:         0012-Fedora-use-clap-4.2.7.patch
# * az-snp-vtpm/az-tdx-vtpm 0.7.4
Patch13:         0013-Fedora-az-snp-vtpm-az-tdx-vtpm-0.7.4.patch
# * kbs-types 0.13.0
Patch14:         0014-Fedora-kbs-types-0.13.0.patch
# * serde_version is 3.12.0
Patch15:         0015-Fedora-serde_with-3.12.0.patch
# * refactor: adapt to kbs-types InitData/RuntimeData type changes
Patch16:         0016-Fedora-refactor-adapt-to-kbs-types-InitData-RuntimeD.patch
# * resolve Tee serialization mismatch with kbs-types
Patch17:         0017-Fedora-resolve-Tee-serialization-mismatch-with-kbs-t.patch

ExclusiveArch:  x86_64
BuildRequires:  cargo-rpm-macros >= 24


%global _description %{expand:
Running in a confidential VM, gather confidential-computing evidence,
send it to Trustee and get secrets.
A part of the confidential-containers project}

%description %{_description}

%prep
%autosetup -n %{projectname}-%{version} -p1
# Cargo.lock isn't uptodate and rpmbuild set --offline
rm -f Cargo.lock
# Work in kbs_protocol directory
cd attestation-agent/kbs_protocol
%cargo_prep

%generate_buildrequires
%cargo_generate_buildrequires

%build
cd attestation-agent/kbs_protocol
%cargo_build
%{cargo_license_summary}
%{cargo_license} > LICENSE.dependencies
mv LICENSE.dependencies ../../

%install
cd attestation-agent/kbs_protocol
mkdir -p %{buildroot}%{_docdir}/%{name}
install -m 0644 src/bin/trustee-attester/README.md %{buildroot}%{_docdir}/%{name}/trustee-attester-README.md
%cargo_install

%if %{with check}
%check
cd attestation-agent/kbs_protocol
%cargo_test
%endif

%files
%license LICENSE
%license LICENSE.dependencies
%doc README.md
%doc trustee-attester-README.md
%{_bindir}/trustee-attester

%changelog
%autochangelog
