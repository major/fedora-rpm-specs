# Generated by go2rpm 1.18.0
# Tests require docker/podman to run
%bcond check 0

# https://code.forgejo.org/forgejo/runner
%global goipath         code.forgejo.org/forgejo/runner/v12
%global forgeurl        https://code.forgejo.org/forgejo/runner
%global archivename     %{name}-%{version}
Version:                12.7.0

%gometa -L -f


Name:           forgejo-runner
Release:        %autorelease
Summary:        A daemon that fetches workflows to run from a Forgejo instance.

# Generated by go-vendor-tools
License:        Apache-2.0 AND BSD-2-Clause AND BSD-3-Clause AND GPL-3.0-only AND ISC AND MIT AND MPL-2.0
URL:            https://code.forgejo.org/forgejo/runner
Source0:        %{url}/archive/v%{version}.tar.gz#/%{name}-%{version}.tar.gz
# Generated by go-vendor-tools
Source1:        %{archivename}-vendor.tar.bz2
Source2:        go-vendor-tools.toml

# Users
Source3:        forgejo-runner.sysusers.conf

Patch:          0000-forgejo_runner-unit_fix.patch

BuildRequires:  go-vendor-tools
BuildRequires:  golang
BuildRequires:  systemd-rpm-macros
%{?sysusers_requires_compat}

Requires:       git-core
Requires:       git-lfs

%description
The Forgejo Runner is a daemon that fetches workflows to run from a Forgejo instance, executes them,
sends back with the logs and ultimately reports its success or failure.

%prep
%goprep -A
%if 0%{?epel} && 0%{?epel} <= 10
%autosetup -n runner -a1 -p1
%else
%autosetup -C -a1 -p1
%endif

%generate_buildrequires
%go_vendor_license_buildrequires -c %{S:2}

%build
%global gomodulesmode GO111MODULE=on
export GO_LDFLAGS=" \
    -X \"code.forgejo.org/forgejo/runner/v12/internal/pkg/ver.version=v%{version}\" \
"
%gobuild -o %{gobuilddir}/bin/forgejo-runner %{goipath}
%{gobuilddir}/bin/forgejo-runner generate-config > config.yml

%install
%go_vendor_license_install -c %{S:2}
install -d %{buildroot}%{_bindir}
install -d %{buildroot}%{_sysusersdir}
install -d %{buildroot}%{_sysconfdir}/forgejo-runner/
install -d %{buildroot}%{_unitdir}
install -d %{buildroot}%{_sharedstatedir}/forgejo-runner/

install -m 755 -p %{gobuilddir}/bin/forgejo-runner %{buildroot}%{_bindir}/forgejo-runner
install -m 644 -p config.yml %{buildroot}%{_sysconfdir}/forgejo-runner/config.yml
install -m 644 -p %{S:3} %{buildroot}%{_sysusersdir}/forgejo-runner.conf
install -m 644 -p contrib/forgejo-runner.service %{buildroot}%{_unitdir}/forgejo-runner.service

%check
%go_vendor_license_check -c %{S:2}
%if %{with check}
%gotest ./...
%endif

%pre
%sysusers_create_compat %{S:3}

%post
%systemd_post forgejo-runner.service

%preun
%systemd_preun forgejo-runner.service

%postun
%systemd_postun_with_restart forgejo-runner.service

%files -f %{go_vendor_license_filelist}
%license vendor/modules.txt
%doc examples README.md RELEASE-NOTES.md release-notes/
%attr(755, -, -) %{_bindir}/forgejo-runner
%config(noreplace) %attr(644, -, -) %{_sysconfdir}/forgejo-runner/config.yml
%config(noreplace) %attr(755, forgejo-runner, forgejo-runner) %{_sharedstatedir}/forgejo-runner/
%{_sysusersdir}/forgejo-runner.conf
%{_unitdir}/forgejo-runner.service

%changelog
%autochangelog
