# Generated by go2rpm 1.18.0
%bcond check 1

%global __provides_exclude_from ^%{_libdir}/security/.*\.so$

# https://github.com/linuxdeepin/deepin-pw-check
%global goipath         github.com/linuxdeepin/deepin-pw-check
Version:                6.0.6
%global tag             6.0.6

%gometa -L

Name:           deepin-pw-check
Release:        %autorelease
Summary:        A tool to verify the validity of the password

# Generated by go-vendor-tools
License:        Apache-2.0 AND BSD-2-Clause AND BSD-3-Clause AND CC-BY-4.0 AND CC0-1.0 AND GPL-2.0-only AND GPL-3.0-only AND GPL-3.0-or-later AND ISC AND MIT
URL:            %{gourl}
Source0:        %{gosource}
# Generated by go-vendor-tools
Source1:        %{archivename}-vendor.tar.bz2
Source2:        go-vendor-tools.toml
Patch1:         0001-Adapt-to-Fedora-cracklib-API.patch

BuildRequires:  go-vendor-tools
BuildRequires:  gcc
BuildRequires:  make
BuildRequires:  pam-devel
BuildRequires:  pkgconfig(gio-2.0)
BuildRequires:  pkgconfig(gdk-3.0)
BuildRequires:  deepin-gettext-tools
BuildRequires:  cracklib-devel
BuildRequires:  iniparser-devel
BuildRequires:  libxcrypt-devel
# for testing
BuildRequires:  cracklib-dicts

%description
deepin-pw-check is a tool to verify the validity of the password.

%package        devel
Summary:        Development files for %{name}
Requires:       %{name}%{?_isa} = %{version}-%{release}
Requires:       cracklib-devel%{?_isa}
Requires:       iniparser-devel%{?_isa}

%description    devel
This package contains development files for %{name}.

%prep
%goprep -A
%setup -q -T -D -a1 %{forgesetupargs}
%autopatch -p1

sed -i 's|${PREFIX}/lib|${PREFIX}/%{_lib}|; s|cp|cp -a|' Makefile
sed -i 's|${DESTDIR}/lib|${DESTDIR}${PREFIX}/lib|' Makefile
sed -i 's|/usr/lib|%{_libdir}|' misc/pkgconfig/libdeepin_pw_check.pc

# expand build_ldflags at %%build section, RHBZ#2044028
sed -i 's|gcc |gcc %{build_cflags} %{build_ldflags} |' Makefile

%generate_buildrequires
%go_vendor_license_buildrequires -c %{S:2}

%build
%global gomodulesmode GO111MODULE=on
export CGO_CFLAGS="%{optflags} -std=gnu17"
%make_build

%install
%go_vendor_license_install -c %{S:2}
%make_install PKG_FILE_DIR=%{_libdir}/pkgconfig PAM_MODULE_DIR=%{_libdir}/security

rm %{buildroot}%{_libdir}/*.a

%find_lang deepin-pw-check

%check
%go_vendor_license_check -c %{S:2}
%if %{with check}
export CGO_CFLAGS="%{optflags} -std=gnu17"
%gotest ./...
make test
%endif

%files -f deepin-pw-check.lang -f %{go_vendor_license_filelist}
%license vendor/modules.txt
%doc README.md
%{_bindir}/pwd-conf-update
%dir %{_libdir}/deepin-pw-check
%{_libdir}/deepin-pw-check/deepin-pw-check
%{_unitdir}/deepin-passwd-conf.service
%{_libdir}/libdeepin_pw_check.so.1*
%{_libdir}/security/pam_deepin_pw_check.so
%{_datadir}/dbus-1/system-services/org.deepin.dde.PasswdConf1.service
%{_datadir}/dbus-1/system.d/org.deepin.dde.PasswdConf1.conf
%{_datadir}/polkit-1/actions/org.deepin.dde.passwdconf.policy

%files devel
%{_libdir}/libdeepin_pw_check.so
%{_libdir}/pkgconfig/libdeepin_pw_check.pc
%{_includedir}/deepin_pw_check.h

%changelog
%autochangelog
