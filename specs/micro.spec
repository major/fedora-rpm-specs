%global shortcommit     6a62575

# Generated by go2rpm 1.19.0
%bcond check 1

# https://github.com/micro-editor/micro
%global goipath         github.com/zyedidia/micro/v2
Version:                2.0.15

%gometa -L -f


Name:           micro
Release:        %autorelease
Summary:        A modern and intuitive terminal-based text editor

# Generated by go-vendor-tools
License:        Apache-2.0 AND BSD-2-Clause AND BSD-3-Clause AND ISC AND JSON AND MIT AND MPL-1.1 AND MPL-2.0
URL:            %{gourl}
Source0:        %{gosource}
# Generated by go-vendor-tools
Source1:        %{archivename}-vendor.tar.bz2
Source2:        go-vendor-tools.toml

BuildRequires:  go-vendor-tools
BuildRequires:  libappstream-glib

%description
Micro is a terminal-based text editor that aims to be easy to use and
intuitive, while also taking advantage of the full capabilities of modern
terminals. It comes as one single, batteries-included, static binary with no
dependencies, and you can download and use it right now.

As the name indicates, micro aims to be somewhat of a successor to the nano
editor by being easy to install and use in a pinch, but micro also aims to be
enjoyable to use full time, whether you work in the terminal because you prefer
it (like me), or because you need to (over ssh).

%prep
%goprep -p1
tar -xf %{S:1}

# Older version of appstream-util can't parse some url types
%if (%{defined rhel} && 0%{?rhel} <= 9)
sed -i '/type="vcs-browser"/d' ./data/io.github.zyedidia.micro.metainfo.xml
sed -i '/type="contribute"/d' ./data/io.github.zyedidia.micro.metainfo.xml
%endif

%generate_buildrequires
%go_vendor_license_buildrequires -c %{S:2}

%build
%global gomodulesmode GO111MODULE=on
export micro_buildtime=$(date -d "@${SOURCE_DATE_EPOCH}" +"%B %d, %Y")
export GO_LDFLAGS="-X github.com/zyedidia/micro/v2/internal/util.Version=%{version} \
                   -X github.com/zyedidia/micro/v2/internal/util.CommitHash=%{shortcommit} \
                   -X 'github.com/zyedidia/micro/v2/internal/util.CompileDate=$micro_buildtime'"
go generate ./runtime
%gobuild -o %{gobuilddir}/bin/%{name} %{goipath}/cmd/%{name}


%install
%go_vendor_license_install -c %{S:2}
install -m 0755 -vd                     %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/* %{buildroot}%{_bindir}/
install -m 0644 -D  data/io.github.zyedidia.micro.metainfo.xml %{buildroot}%{_metainfodir}/io.github.zyedidia.micro.metainfo.xml

%check
%go_vendor_license_check -c %{S:2}
%if %{with check}
%gotest ./...
appstream-util validate-relax --nonet %{buildroot}%{_datadir}/metainfo/io.github.zyedidia.micro.metainfo.xml
%endif

%files -f %{go_vendor_license_filelist}
%doc README.md
%{_bindir}/micro
%{_metainfodir}/io.github.zyedidia.micro.metainfo.xml

%changelog
%autochangelog
