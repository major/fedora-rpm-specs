%global pypi_name coincurve
# The C extension is generated by CFFI at build time and compiled via
# scikit-build-core inside pip's isolated temporary build directory. The DWARF
# source paths reference this ephemeral directory, which is cleaned up before
# find-debuginfo runs, leaving debugsourcefiles.list empty. Debuginfo (symbols)
# is preserved; only the debugsource subpackage is suppressed.
%undefine _debugsource_packages

Name:          python-%{pypi_name}
Version:       21.0.0
Release:       %autorelease
Summary:       Cross-platform Python bindings for libsecp256k1
# A part which is autogenerated from libsecp256k1 header files is licensed
# under MIT only. The other part written in Python is licensed under "MIT or
# Apache-2.0".
License:       MIT and (MIT or Apache-2.0)
URL:           https://github.com/ofek/coincurve
VCS:           git:%{url}.git
Source0:       %{pypi_source %{pypi_name}}
# Fedora-specific. Fedora ships a higher but still compatible versions of a
# build dependencies.
Patch:         python-coincurve-0001-Relax-dependency.patch
# Fedora-specific. Use our system-wide lib instead of downloading and building
# bundled copy.
Patch:         python-coincurve-0002-Customize-CMake-defaults.patch
# Fedora-specific. We keep debuginfo and ship it in a separate package.
Patch:         python-coincurve-0003-Don-t-strip-binary.patch
# Fedora-specific. We prefer our own C(XX)FLAGS.
Patch:         python-coincurve-0004-Don-t-override-C-XX-FLAGS.patch
BuildRequires: cmake
BuildRequires: gcc
BuildRequires: libsecp256k1-devel >= 0.4.1
BuildRequires: pkgconfig
BuildRequires: python3-pytest
BuildSystem:   pyproject
BuildOption(install): %{pypi_name}
Requires: python3-cffi

%description
%{summary}.

%package -n python3-%{pypi_name}
Summary: %{summary}

%description -n python3-%{pypi_name}
%{summary}.

%prep -a
rm -rf docs/.scripts docs/.snippets docs/assets
rm hatch_build.py
sed -i '/^\[tool\.hatch\.build\.targets\.wheel\.hooks\.custom\]$/d' pyproject.toml

%build -p
export COINCURVE_VENDOR_CFFI=0

%check -a
%pytest

%files -n python3-%{pypi_name} -f %{pyproject_files}
%license LICENSE-MIT LICENSE-APACHE
%doc docs/ README.md

%changelog
%autochangelog
