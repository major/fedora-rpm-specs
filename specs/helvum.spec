# Generated by rust2rpm 26
%bcond_without check

# prevent library files from being installed
%global cargo_install_lib 0

%global commit      980bb139e9d85d31f93045cc8a600429aa481aad
%global shortcommit %{sub %{commit} 1 7}
%global commitdate  20240829

Name:           helvum
Version:        0.5.1^%{commitdate}.git%{shortcommit}
Release:        %autorelease
Summary:        GTK patchbay for pipewire

SourceLicense:  GPL-3.0-only
# Apache-2.0 OR MIT
# GPL-3.0-only
# MIT
# MIT OR Apache-2.0
# Unlicense OR MIT
License:        GPL-3.0-only AND (Apache-2.0 OR MIT) AND MIT AND (Unlicense OR MIT)
# LICENSE.dependencies contains a full license breakdown

URL:            https://gitlab.freedesktop.org/pipewire/helvum
Source:         %{url}/-/archive/%{commit}/helvum-%{commit}.tar.gz

# * port to gtk-rs v0.20, gtk4-rs v0.9, and libadwaita-rs v0.7 
Patch:          0001-port-to-gtk-rs-0.20-and-libadwaita-rs-0.7.patch

BuildRequires:  cargo-rpm-macros >= 26
BuildRequires:  meson
BuildRequires:  desktop-file-utils
BuildRequires:  appstream
BuildRequires:  libappstream-glib

%global _description %{expand:
A GTK patchbay for pipewire.}

%description %{_description}

%prep
%autosetup -n helvum-%{commit} -p1
# build cargo project directly with cargo
sed -i -e '/\(build_by_default\|install\)/s/true/false/' src/meson.build
sed -i -e '/dependency/d' meson.build
sed -i -e '/Cargo.lock/d' meson.build
%cargo_prep

%generate_buildrequires
%cargo_generate_buildrequires

%build
%cargo_build
%{cargo_license_summary}
%{cargo_license} > LICENSE.dependencies
%meson
%meson_build

%install
%cargo_install
%meson_install

%check
%if %{with check}
%cargo_test
%endif
desktop-file-validate \
    %{buildroot}/%{_datadir}/applications/org.pipewire.Helvum.desktop
appstream-util validate-relax --nonet \
    %{buildroot}/%{_datadir}/metainfo/org.pipewire.Helvum.metainfo.xml
appstreamcli validate --no-net \
    %{buildroot}/%{_datadir}/metainfo/org.pipewire.Helvum.metainfo.xml

%files
%license LICENSE
%license LICENSE.dependencies
%doc README.md
%{_bindir}/helvum
%{_datadir}/applications/org.pipewire.Helvum.desktop
%{_datadir}/icons/hicolor/*/apps/org.pipewire.Helvum*.svg
%{_datadir}/metainfo/org.pipewire.Helvum.metainfo.xml

%changelog
%autochangelog
